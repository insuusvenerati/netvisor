name: Build ARMv7l Binaries

on:
  push:
    branches: [main, develop]
    tags:
      - "v*"
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  build-armv7l:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: armv7-unknown-linux-gnueabihf
            binary: server
          - target: armv7-unknown-linux-gnueabihf
            binary: daemon

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-unknown-linux-gnueabihf

      - name: Install ARM cross-compilation dependencies
        run: |
          # Install cross-compiler and cross libc headers (these are available for amd64 runners)
          sudo apt-get update
          sudo apt-get install -y \
            gcc-arm-linux-gnueabihf \
            libc6-dev-armhf-cross \
            libssl-dev || true
          # If the above failed for any reason, print a friendly note with suggestions
          if [ $? -ne 0 ]; then
            echo "Warning: some host packages failed to install. Consider using 'cross' or building static artifacts."
          fi

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: backend/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build ${{ matrix.binary }} for armv7l
        run: |
          cd backend
          cargo build --release --bin ${{ matrix.binary }} --target armv7-unknown-linux-gnueabihf

      - name: Verify binary architecture
        run: |
          file backend/target/armv7-unknown-linux-gnueabihf/release/${{ matrix.binary }}
          ls -lh backend/target/armv7-unknown-linux-gnueabihf/release/${{ matrix.binary }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: netvisor-${{ matrix.binary }}-armv7l
          path: backend/target/armv7-unknown-linux-gnueabihf/release/${{ matrix.binary }}
          retention-days: 30

  build-multiarch-docker:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU for multi-architecture builds
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push multi-architecture server image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./backend/Dockerfile.multiarch
          platforms: linux/amd64,linux/arm/v7,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/netvisor-server:latest
            ${{ secrets.DOCKER_USERNAME }}/netvisor-server:${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push multi-architecture daemon image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile.daemon.multiarch
          platforms: linux/amd64,linux/arm/v7,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/netvisor-daemon:latest
            ${{ secrets.DOCKER_USERNAME }}/netvisor-daemon:${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
